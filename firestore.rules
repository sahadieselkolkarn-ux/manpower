rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isEmailVerified() {
      return isSignedIn() && request.auth.token.email_verified;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isUserAdmin(userId) {
      return getUserData(userId).role == 'ADMIN';
    }

    function getSecuritySettings() {
      return get(/databases/$(database)/documents/settings/security).data;
    }

    // --- Rules Start Here ---

    // SETTINGS: Only admins can read/write security settings.
    match /settings/security {
      allow read: if isSignedIn();
      allow write: if isUserAdmin(request.auth.uid);
    }
    
    match /users/{userId} {
      // READ: Users can read their own profile. Admins can read any profile.
      allow get: if request.auth.uid == userId || isUserAdmin(request.auth.uid);
      
      // LIST: Only admins can list all users.
      allow list: if isUserAdmin(request.auth.uid);
      
      // CREATE: A user can create their OWN profile document, one time only.
      // The role is determined by the bootstrap settings.
      allow create: if request.auth.uid == userId
                    && !exists(/databases/$(database)/documents/users/$(userId))
                    && (
                      // Case 1: Bootstrap is open and user is in allowlist
                      (
                        getSecuritySettings().bootstrap.isOpen == true
                        && request.auth.token.email in getSecuritySettings().bootstrap.adminEmailsAllowlist
                        && request.resource.data.role == 'ADMIN'
                        && request.resource.data.department == 'MANAGEMENT'
                      ) ||
                      // Case 2: Any other case (bootstrap closed, or not in list)
                      (
                        request.resource.data.role == 'PENDING'
                      )
                    )
                    // Validate common fields on creation
                    && request.resource.data.email == request.auth.token.email
                    && request.resource.data.isActive == true;

      // UPDATE: Admins can update any user.
      allow update: if isUserAdmin(request.auth.uid);
    }

    // Default deny all other collections for now
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
